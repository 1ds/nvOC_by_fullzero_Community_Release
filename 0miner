#!/bin/bash

##########################################################################
##########################################################################
#################   nvOC v0019-2.1 - Community Release   #################
##############      by papampi, Stubo, leenoox, damNmad   ################
##########   Based on the original nvOC v0019-1.4 by fullzero   ##########
##########################################################################
##########################################################################

# 0miner for nvOC v0019-2.1 by papampi

# DEV Mod Log:
# v=0001 : papampi: Initial Release
#
# v=0002 : papampi:
#          fix lbc
# v=0003 : papampi:
#          More NiceHash, MINER_PWD failsafe,
#          COIN_EXTENSION_ARGUMENTS for ethminer and genoil
# v=0004 : damNmad:
#          New Coins LUX, SUMO, DSR
# v=0005 : papampi:
#          New Coin ELLA,  XVG, GBX, CRC
# v=0006 : papampi:
#          EQUIHASH_MINER, bminer, ETHASH_MINER
# v=0007 : papampi:
#          Nicehash bug fixes
# v=0008 : papampi:
#          Move all miners to ${NVOC}/miners/
# v=0009 : papampi
#          Pool Wallet Address Format
# v=0010 : papampi
#          New Claymore Dual Mining
# v=0011 : damNmad
#          Added BTCP
# v=0012 : Falcon
#          Added CCMINER_OPTS, added RavenCoin (RVN)
# v=0013 : papampi
#          Changed EWBF HCD
# v=0014 : papampi
#          Code cleanup, NEOSCRYPT_MINER, LYRA2V2_MINER, SKUNK_MINER, SKEIN_MINER
# v=0015 : LukePicci
#          Relocate nvOC to arbitrary install directory
# v=0016 : papampi
#          Prevent running 2 miners
# v=0017 : sizzlephizzle
#	   Unification of EQUIHASH & ETHASH mining by ALGO.
# v=0018 : sizzlephizzle
#	   More algo Unification 

nvOC_Ver="nvOC v0019-2.1 - Community Release"
nvOC_0miner_ver="v0019-2.0.0018"   # Do not edit this

source "${NVOC}/1bash"

# Prevent running 2 miners
if ps ax | grep SCREEN | grep -v cpuminer | grep -q miner ; then
  ps ax | grep SCREEN | grep -v cpuminer | grep miner | awk '"miner" {print $1}' | xargs kill -9
fi

# Set MINER_PWD if unset
if [ -z ${MINER_PWD+x} ]
then
  MINER_PWD="x"
fi

## Unify COIN Start
UPOOL="_POOL"
UPORT="_PORT"
UEXT="_EXTENSION_ARGUMENTS"
UADDR="_ADDRESS"
UWORK="_WORKER"
UINTENSITY="_INTENSITY"
LAUNCH="screen -c ${NVOC}/screenrc-miner -dmSL miner"
xpool=$COIN$UPOOL
xport=$COIN$UPORT
xadd=$COIN$UADDR
xwrk=$COIN$UWORK
xext=$COIN$UEXT
xintensity=$ALGO$UINTENSITY
CLN=:
## Unify COIN End

## NICEHASH 
if [[ ${COIN:0:4} == NICE ]]
then
  NICE_NEOSCRYPT_ADDRESS=$NICE_ADDRESS
  NICE_LYRA2REV2_ADDRESS=$NICE_ADDRESS
  NICE_X11GOST_ADDRESS=$NICE_ADDRESS
  NICE_SKUNKHASH_ADDRESS=$NICE_ADDRESS
  NICE_CRYPTONIGHT_ADDRESS=$NICE_ADDRESS
  NICE_EQUIHASH_ADDRESS=$NICE_ADDRESS
  NICE_ETHASH_ADDRESS=$NICE_ADDRESS
fi

## ZPOOL 
if [[ ${COIN:0:4} == ZPOOL ]]
then
  ZPOOL_ADDRESS=$BTC_ADDRESS
  ZPOOL_WORKER="$WORKERNAME"
  ZPOOL_NEOSCRYPT_ADDRESS=$BTC_ADDRESS
  ZPOOL_LYRA2REV2_ADDRESS=$BTC_ADDRESS
  ZPOOL_BLAKE2S_ADDRESS=$BTC_ADDRESS
  ZPOOL_SKUNK_ADDRESS=$BTC_ADDRESS
  ZPOOL_CRYPTONIGHT_ADDRESS=$BTC_ADDRESS
  ZPOOL_EQUIHASH_ADDRESS=$BTC_ADDRESS
  ZPOOL_ETHASH_ADDRESS=$BTC_ADDRESS
  ZPOOL_LBRY_ADDRESS=$BTC_ADDRESS
  ZPOOL_SKEIN_ADDRESS=$BTC_ADDRESS
fi
## MPH 
if [[ ${COIN:0:4} == MPH ]]
then
  MPH_WORKER="$WORKERNAME"
  MPH_NEOSCRYPT_ADDRESS=$MPH_ADDRESS
  MPH_LYRA2REV2_ADDRESS=$MPH_ADDRESS
  MPH_LYRA2Z_ADDRESS=$MPH_ADDRESS
  MPH_CRYPTONIGHT_ADDRESS=$MPH_ADDRESS
  MPH_EQUIHASH_ADDRESS=$MPH_ADDRESS
  MPH_ETHASH_ADDRESS=$MPH_ADDRESS
  MPH_SKEIN_ADDRESS=$MPH_ADDRESS
  MPH_CRYPTONIGHT_MONERO==$MPH_ADDRESS
fi

## ETHASH
if [[ $ALGO == ETHASH ]];
then
  ## Declare Miner Start
  if [[ $ETHASH_MINER == GENOIL ]];
  then
    HCD="$LAUNCH ${NVOC}/miners/Genoil-U/ethminer -S "${!xpool}"$CLN"${!xport}" -O "${!xadd}"$ETHASH_WALLET_FORMAT"${!xwrk}":$MINER_PWD -SP 1 -U "${!xext}""
  fi

  if [[ $ETHASH_MINER == ETHMINER ]];
  then
    HCD="$LAUNCH ${NVOC}/miners/ethminer/latest/ethminer -S "${!xpool}"$CLN"${!xport}" -O "${!xadd}"$ETHASH_WALLET_FORMAT"${!xwrk}":$MINER_PWD -SP 1 -U "${!xext}""
  fi

  if [[ $ETHASH_MINER == CLAYMORE ]];
  then
    HCD="$LAUNCH ${NVOC}/miners/claymore/$CLAYMORE_VERSION/ethdcrminer64 -epool "${!xpool}"$CLN"${!xport}" -ewal "${!xadd}"$ETHASH_WALLET_FORMAT"${!xwrk}" -epsw $MINER_PWD  -mode 1 -allcoins 1 -allpools 1 -dbg -1 "${!xext}""
  fi
  ## Declare Miner End
  $HCD
fi

## EQUIHASH
if [[ $ALGO == EQUIHASH ]];
then
  if [[ $EQUIHASH_MINER == ZM ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/dstm/latest/zm_miner --server "${!xpool}" --user "${!xadd}"$EQUIHASH_WALLET_FORMAT"${!xwrk}" --port "${!xport}" --pass $MINER_PWD --time $ZM_OPTS "${!xext}""
  fi
  if [[ $EQUIHASH_MINER == EWBF ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/ewbf/v$EWBF_VERSION/miner --eexit 3 --fee $EWBF_PERCENT --pec --server "${!xpool}" --user "${!xadd}"$EQUIHASH_WALLET_FORMAT"${!xwrk}" --pass $MINER_PWD --port "${!xport}" $EWBF_OPTS "${!xext}""
  fi
  if [[ $EQUIHASH_MINER == BMINER ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/bminer/latest/bminer -uri stratum://"${!xadd}"$EQUIHASH_WALLET_FORMAT"${!xwrk}":$MINER_PWD@"${!xpool}"$CLN"${!xport}" $BMINER_OPTS "${!xext}""
  fi
  if [[ $EQUIHASH_MINER == BMINER_SSL ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/bminer/latest/bminer -uri stratum+ssl://"${!xadd}"$EQUIHASH_WALLET_FORMAT"${!xwrk}":$MINER_PWD@"${!xpool}"$CLN"${!xport}" $BMINER_OPTS "${!xext}" "
  fi
  $HCD
fi

## CLAYMORE_DUAL
if [[ $COIN == CLAYMORE_DUAL ]]
then
  HCD=${NVOC}/miners/claymore/$CLAYMORE_VERSION/ethdcrminer64
  E_ADDR="$DUAL_EWAL$ETHASH_WALLET_FORMAT$DUAL_EWORKER"
  D_ADDR="$DUAL_DWAL$DUAL_WALLET_FORMAT$DUAL_DWORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -epool $DUAL_EPOOL:$DUAL_EPORT -ewal $E_ADDR -epsw  $DUAL_EPSW -dpool stratum+tcp://$DUAL_DPOOL:$DUAL_DPORT -dwal $D_ADDR -dpsw $DUAL_DPSW -dcoin $DUAL_DCOIN -allpools $ALL_POOLS -dbg -1 -mport $MPORT -mpsw $MPSW $DUAL_ADDITIONAL_ARGUMENTS
fi
## CLAYMORE_DUAL

## LYRA2V2
if [[ $ALGO == LYRA2V2 ]];
then
  WALLET_ADDRESS_FORMAT="$LYRA2V2_WALLET_FORMAT"
  HCD=${NVOC}/miners/"$LYRA2V2_MINER"/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a lyra2v2 -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## NEOSCRYPT
if [[ $ALGO == NEOSCRYPT ]];
then
  WALLET_ADDRESS_FORMAT="$NEOSCRYPT_WALLET_FORMAT"
  HCD=${NVOC}/miners/"$NEOSCRYPT_MINER"/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a neoscrypt -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## SKEIN
if [[ $ALGO == SKEIN ]];
then
  WALLET_ADDRESS_FORMAT="$SKEIN_WALLET_FORMAT"
  HCD=${NVOC}/miners/"$SKEIN_MINER"/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a skein -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## KECCAK
if [[ $ALGO == KECCAK ]];
then
  WALLET_ADDRESS_FORMAT="$KECCAK_WALLET_FORMAT"
  HCD=${NVOC}/miners/"$XEVAN_MINER"/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a keccak -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## SKUNK
if [[ $ALGO == SKUNK ]];
then
  WALLET_ADDRESS_FORMAT="$SKUNK_WALLET_FORMAT"
  HCD=${NVOC}/miners/"$SKUNK_MINER"/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a skunk -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## LYRA2Z
if [[ $ALGO == LYRA2Z ]];
then
  WALLET_ADDRESS_FORMAT="$LYRA2Z_WALLET_FORMAT"
  HCD=${NVOC}/miners/"$LYRA2Z_MINER"/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a lyra2z -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## SIB, X11GHOST
if [[ $ALGO == SIB ]];
then
  WALLET_ADDRESS_FORMAT="$SIB_WALLET_FORMAT"
  HCD=${NVOC}/miners/"$SIB_MINER"/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a sib -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## X16R
if [[ $ALGO == X16R ]];
then
  WALLET_ADDRESS_FORMAT=$X16R_WALLET_FORMAT
  if [[ $X16R_MINER == Z-ENEMY ]]
  then
    HCD=${NVOC}/miners/z-enemy/z-enemy_miner 
  fi
  if [[ $X16R_MINER == SILENT ]]
  then
    HCD=${NVOC}/miners/silent_miner/ccminer 
  fi
  if [[ $X16R_MINER == SUPRMINER ]]
  then
    HCD=${NVOC}/miners/suprminer/ccminer
  fi
  screen -c ${NVOC}/screenrc-miner -dmSL miner-a x16r -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## TIMETRAVEL10
if [[ $ALGO == TIMETRAVEL10 ]];
then
  WALLET_ADDRESS_FORMAT="$TIMETRAVEL10_WALLET_FORMAT"
  HCD=${NVOC}/miners/"$TIMETRAVEL10_MINER"/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a timetravel10 -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## CRYPTONIGHT
if [[ $ALGO == CRYPTONIGHT ]];
then
  WALLET_ADDRESS_FORMAT="$CRYPTONIGHT_WALLET_FORMAT"
  HCD=${NVOC}/miners/KTccminer-cryptonight/ccminer
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

## CRYPTONIGHTV7
if [[ $ALGO == CRYPTONIGHTV7 ]];
then
  # Remove nvidia.txt incase cards changed
  if [ -f ${NVOC}/nvidia.txt ] 
  then
    rm ${NVOC}/nvidia.txt
  fi
  # Change verbosity to show hashrate in output log
  if grep '"verbose_level" : 3' ${NVOC}/config.txt
  then
    sed -i 's/"verbose_level" : 3/"verbose_level" : 4/g' ${NVOC}/config.txt
  fi
  WALLET_ADDRESS_FORMAT="$CRYPTONIGHTV7_WALLET_FORMAT"
  HCD=${NVOC}/miners/xmr-stak/build/bin/xmr-stak_miner
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -o stratum+tcp://"${!xpool}"$CLN"${!xport}" -u "${!xadd}"$WALLET_ADDRESS_FORMAT"${!xwrk}" -p $MINER_PWD -i "${!xintensity}" $CCMINER_OPTS
fi

if [[ $COIN == ONION ]]
then
  HCD=${NVOC}/miners/TPccminer/ccminer
  ADDR="$ONION_ADDRESS"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a x13 -o stratum+tcp://$ONION_POOL:$ONION_PORT -u $ADDR -p c=ONION $CCMINER_OPTS
fi

if [[ $COIN == DMD ]]
then
  HCD=${NVOC}/miners/TPccminer/ccminer
  ADDR="$DMD_ADDRESS$WALLET_ADDRESS_FORMAT$DMD_WORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a dmd-gr -o stratum+tcp://$DMD_POOL:$DMD_PORT -u $ADDR -p $MINER_PWD $CCMINER_OPTS
fi

if [[ $COIN == GRS ]]
then
  HCD=${NVOC}/miners/TPccminer/ccminer
  ADDR="$GRS_ADDRESS$WALLET_ADDRESS_FORMAT$GRS_WORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a groestl -o stratum+tcp://$GRS_POOL:$GRS_PORT -u $ADDR -p $MINER_PWD $CCMINER_OPTS
fi

if [[ $COIN == XMY ]]
then
  HCD=${NVOC}/miners/TPccminer/ccminer
  ADDR="$XMY_ADDRESS$WALLET_ADDRESS_FORMAT$XMY_WORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a myr-gr -o stratum+tcp://$XMY_POOL:$XMY_PORT -u $ADDR -p $MINER_PWD -i $XMY_INTENSITY $CCMINER_OPTS
fi

if [[ $COIN == LBC ]]
then
  HCD=${NVOC}/miners/SPccminer/ccminer
  ADDR="$LBC_ADDRESS$WALLET_ADDRESS_FORMAT$LBC_WORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a lbry -o stratum+tcp://$LBC_POOL:$LBC_PORT -u $ADDR -p $MINER_PWD -i $LBC_INTENSITY $CCMINER_OPTS
fi

if [[ $COIN == DCR ]]
then
  HCD=${NVOC}/pasc/sgminer
  ADDR="$DCR_ADDRESS$WALLET_ADDRESS_FORMAT$DCR_WORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -k decred -o stratum+tcp://$DCR_POOL:$DCR_PORT -u $ADDR -p $MINER_PWD  -I 21 -w 64 -g2
fi

if [[ $COIN == PASC ]]
then
  HCD=${NVOC}/pasc/sgminer
  ADDR="$PASC_ADDRESS$WALLET_ADDRESS_FORMAT.$PASC_WORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -k pascal -o $PASC_POOL:$PASC_PORT -u $ADDR  -p $MINER_PWD -I 21 -w 64 -g2
fi

if [[ $COIN == PASL ]]
then
  HCD=${NVOC}/pasc/sgminer
  ADDR="$PASL_ADDRESS$WALLET_ADDRESS_FORMAT$PASL_WORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -k pascal -o stratum+tcp://$PASL_POOL:$PASL_PORT -u $ADDR  -p $MINER_PWD -I 21 -w 64 -g2
fi

if [[ $COIN == SIA ]]
then
  HCD=${NVOC}/miners/SPccminer/ccminer
  SCADDR="$SC_ADDRESS$WALLET_ADDRESS_FORMAT$SC_WORKER"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a sia -o $SC_GW_POOL:$SC_GW_PORT -u $SCADDR -p $MINER_PWD  $CCMINER_OPTS
fi

if [[ $COIN == LUX ]]
then
  HCD=${NVOC}/miners/ANXccminer/ccminer
  ADDR="$LUX_ADDRESS"
  screen -c ${NVOC}/screenrc-miner -dmSL miner $HCD -a phi -o stratum+tcp://$LUX_POOL:$LUX_PORT -u $ADDR -p $LUX_WORKER -i $LUX_INTENSITY $CCMINER_OPTS
fi


