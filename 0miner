#!/bin/bash

##########################################################################
##########################################################################
#################   nvOC v0019-2.1 - Community Release   #################
##############      by papampi, Stubo, leenoox, damNmad   ################
##########   Based on the original nvOC v0019-1.4 by fullzero   ##########
##########################################################################
##########################################################################

# 0miner for nvOC v0019-2.1 by papampi

# DEV Mod Log:
# v=0001 : papampi: Initial Release
#
# v=0002 : papampi:
#          fix lbc
# v=0003 : papampi:
#          More NiceHash, MINER_PWD failsafe,
#          COIN_EXTENSION_ARGUMENTS for ethminer and genoil
# v=0004 : damNmad:
#          New Coins LUX, SUMO, DSR
# v=0005 : papampi:
#          New Coin ELLA,  XVG, GBX, CRC
# v=0006 : papampi:
#          EQUIHASH_MINER, bminer, ETHASH_MINER
# v=0007 : papampi:
#          Nicehash bug fixes
# v=0008 : papampi:
#          Move all miners to "${NVOC}"/miners/
# v=0009 : papampi
#          Pool Wallet Address Format
# v=0010 : papampi
#          New Claymore Dual Mining
# v=0011 : damNmad
#          Added BTCP
# v=0012 : Falcon
#          Added CCMINER_OPTS, added RavenCoin (RVN)
# v=0013 : papampi
#          Changed EWBF HCD
# v=0014 : papampi
#          Code cleanup, NEOSCRYPT_MINER, LYRA2V2_MINER, SKUNK_MINER, SKEIN_MINER
# v=0015 : LukePicci
#          Relocate nvOC to arbitrary install directory
# v=0016 : papampi
#          Prevent running 2 miners
# v=0017 : sizzlephizzle
#	   Unification of EQUIHASH & ETHASH mining by ALGO.
# v=0018 : papampi
#	   Algo Unification for all algorithms


nvOC_Ver="nvOC v0019-2.1 - Community Release"
nvOC_0miner_ver="v0019-2.0.0018"   # Do not edit this

source "${NVOC}/1bash"

# Prevent running 2 miners
if ps ax | grep SCREEN | grep -v cpuminer | grep -q miner ; then
  ps ax | grep SCREEN | grep -v cpuminer | grep miner | awk '"miner" {print $1}' | xargs kill -9
fi

# Set MINER_PWD if unset
if [ -z "${MINER_PWD+x}" ]
then
  MINER_PWD="x"
fi


## Unify COIN Start
UPOOL="_POOL"
UPORT="_PORT"
UEXT="_EXTENSION_ARGUMENTS"
UADDR="_ADDRESS"
UWORK="_WORKER"
UINTENSITY="_INTENSITY"
LAUNCH="screen -c ${NVOC}/screenrc-miner -dmSL miner"
xpool=$COIN$UPOOL
xport=$COIN$UPORT
xadd=$COIN$UADDR
xwrk=$COIN$UWORK
xext=$COIN$UEXT
xintensity=$ALGO$UINTENSITY

## Unify COIN End

## NICEHASH
if [[ ${COIN:0:4} == NICE ]]
then
  NICE_NEOSCRYPT_ADDRESS=$NICE_ADDRESS
  NICE_LYRA2REV2_ADDRESS=$NICE_ADDRESS
  NICE_X11GOST_ADDRESS=$NICE_ADDRESS
  NICE_SKUNKHASH_ADDRESS=$NICE_ADDRESS
  NICE_CRYPTONIGHT_ADDRESS=$NICE_ADDRESS
  NICE_EQUIHASH_ADDRESS=$NICE_ADDRESS
  NICE_ETHASH_ADDRESS=$NICE_ADDRESS
## ZPOOL
elif [[ ${COIN:0:5} == ZPOOL ]]
then
  ZPOOL_NEOSCRYPT_ADDRESS=$BTC_ADDRESS
  ZPOOL_LYRA2REV2_ADDRESS=$BTC_ADDRESS
  ZPOOL_BLAKE2S_ADDRESS=$BTC_ADDRESS
  ZPOOL_SKUNK_ADDRESS=$BTC_ADDRESS
  ZPOOL_CRYPTONIGHT_ADDRESS=$BTC_ADDRESS
  ZPOOL_EQUIHASH_ADDRESS=$BTC_ADDRESS
  ZPOOL_ETHASH_ADDRESS=$BTC_ADDRESS
  ZPOOL_LBRY_ADDRESS=$BTC_ADDRESS
  ZPOOL_SKEIN_ADDRESS=$BTC_ADDRESS
## MPH
elif [[ ${COIN:0:3} == MPH ]]
then
  MPH_NEOSCRYPT_ADDRESS=$MPH_ADDRESS
  MPH_LYRA2REV2_ADDRESS=$MPH_ADDRESS
  MPH_LYRA2Z_ADDRESS=$MPH_ADDRESS
  MPH_CRYPTONIGHT_ADDRESS=$MPH_ADDRESS
  MPH_EQUIHASH_ADDRESS=$MPH_ADDRESS
  MPH_ETHASH_ADDRESS=$MPH_ADDRESS
  MPH_SKEIN_ADDRESS=$MPH_ADDRESS
  MPH_CRYPTONIGHTV7==$MPH_ADDRESS
fi

## CLAYMORE_DUAL
if [[ $COIN == CLAYMORE_DUAL ]]
then
  HCD=${NVOC}/miners/claymore/$CLAYMORE_VERSION/ethdcrminer64
  E_ADDR="$DUAL_EWAL""$ETHASH_WALLET_FORMAT""$DUAL_EWORKER"
  D_ADDR="$DUAL_DWAL""$DUAL_WALLET_FORMAT""$DUAL_DWORKER"
  screen -c "${NVOC}"/screenrc-miner -dmSL miner "$HCD" -epool "$DUAL_EPOOL":"$DUAL_EPORT" -ewal "$E_ADDR" -epsw "$DUAL_EPSW" -dpool stratum+tcp://"$DUAL_DPOOL":"$DUAL_DPORT" -dwal "$D_ADDR" -dpsw "$DUAL_DPSW" -dcoin "$DUAL_DCOIN" -allpools "$ALL_POOLS" -dbg -1 -mport "$MPORT" -mpsw "$MPSW" "$DUAL_ADDITIONAL_ARGUMENTS"
fi

## ETHASH
if [[ $ALGO == ETHASH ]]
then
## Declare Miner Start
  if [[ $ETHASH_MINER == GENOIL ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/Genoil-U/ethminer -S ${!xpool}:${!xport} -O ${!xadd}$ETHASH_WALLET_FORMAT${!xwrk}:$MINER_PWD -SP 1 -U ${!xext}"
  elif [[ $ETHASH_MINER == ETHMINER ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/ethminer/latest/ethminer -S ${!xpool}:${!xport} -O ${!xadd}$ETHASH_WALLET_FORMAT${!xwrk}:$MINER_PWD -SP 1 -U ${!xext}"
  elif [[ $ETHASH_MINER == CLAYMORE ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/claymore/$CLAYMORE_VERSION/ethdcrminer64 -epool ${!xpool}:${!xport} -ewal ${!xadd}$ETHASH_WALLET_FORMAT${!xwrk} -epsw $MINER_PWD  -mode 1 -allcoins 1 -allpools 1 -dbg -1 ${!xext}"
  fi
  $HCD

## EQUIHASH
elif [[ $ALGO == EQUIHASH ]];
then
  if [[ $EQUIHASH_MINER == DSTM ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/dstm/latest/zm_miner --server ${!xpool} --user ${!xadd}$EQUIHASH_WALLET_FORMAT${!xwrk} --port ${!xport} --pass $MINER_PWD --time $DSTM_OPTS ${!xext}"
  elif [[ $EQUIHASH_MINER == EWBF ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/ewbf/$EWBF_VERSION/miner --eexit 3 --fee $EWBF_PERCENT --pec --server ${!xpool} --user ${!xadd}$EQUIHASH_WALLET_FORMAT${!xwrk} --pass $MINER_PWD --port ${!xport} $EWBF_OPTS ${!xext}"
  elif [[ $EQUIHASH_MINER == BMINER ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/bminer/latest/bminer -uri stratum://${!xadd}$EQUIHASH_WALLET_FORMAT${!xwrk}:$MINER_PWD@${!xpool}:${!xport} $BMINER_OPTS ${!xext}"
  elif [[ $EQUIHASH_MINER == BMINER_SSL ]]
  then
    HCD="$LAUNCH ${NVOC}/miners/bminer/latest/bminer -uri stratum+ssl://${!xadd}$EQUIHASH_WALLET_FORMAT${!xwrk}:$MINER_PWD@${!xpool}:${!xport} $BMINER_OPTS ${!xext}"
  fi
  $HCD

elif [[ $ALGO == X16R || $ALGO == SIB || $ALGO == LYRA2Z || $ALGO == SKUNK || $ALGO == KECCAK || $ALGO == SKEIN || $ALGO == NEOSCRYPT || $ALGO == LYRA2V2 || $ALGO == TIMETRAVEL10 || $ALGO == PHI || $ALGO == PASCAL || $ALGO == LBRY || $ALGO == DMDGR || $ALGO == GROESTL || $ALGO == MYR_GR || $ALGO == DCR || $ALGO == SIA || $ALGO == X13 || $ALGO == CRYPTONIGHT ]]
then
## SIB, X11GHOST
  if [[ $ALGO == SIB ]]
  then
    WALLET_ADDRESS_FORMAT="$SIB_WALLET_FORMAT"
    HCD=${NVOC}/miners/"$SIB_MINER"/ccminer
    UCCALGO="-a sib"
  ## LYRA2Z
  elif [[ $ALGO == LYRA2Z ]]
  then
    WALLET_ADDRESS_FORMAT="$LYRA2Z_WALLET_FORMAT"
    HCD=${NVOC}/miners/"$LYRA2Z_MINER"/ccminer
    UCCALGO="-a lyra2z"
  ## SKUNK
  elif [[ $ALGO == SKUNK ]]
  then
    WALLET_ADDRESS_FORMAT="$SKUNK_WALLET_FORMAT"
    HCD=${NVOC}/miners/"$SKUNK_MINER"/ccminer
    UCCALGO="-a skunk"
  ## KECCAK
  elif [[ $ALGO == KECCAK ]]
  then
    WALLET_ADDRESS_FORMAT="$KECCAK_WALLET_FORMAT"
    HCD=${NVOC}/miners/"$XEVAN_MINER"/ccminer
    UCCALGO="-a keccak"
  ## SKEIN
  elif [[ $ALGO == SKEIN ]]
  then
    WALLET_ADDRESS_FORMAT="$SKEIN_WALLET_FORMAT"
    HCD=${NVOC}/miners/"$SKEIN_MINER"/ccminer
    UCCALGO="-a skein"
  ## NEOSCRYPT
  elif [[ $ALGO == NEOSCRYPT ]]
  then
    WALLET_ADDRESS_FORMAT="$NEOSCRYPT_WALLET_FORMAT"
    HCD=${NVOC}/miners/"$NEOSCRYPT_MINER"/ccminer
    UCCALGO="-a neoscrypt"
  ## LYRA2V2
  elif [[ $ALGO == LYRA2V2 ]]
  then
    WALLET_ADDRESS_FORMAT="$LYRA2V2_WALLET_FORMAT"
    HCD="${NVOC}"/miners/"$LYRA2V2_MINER"/ccminer
    UCCALGO="-a lyra2v2"
  ## TIMETRAVEL10
  elif [[ $ALGO == TIMETRAVEL10 ]]
  then
    WALLET_ADDRESS_FORMAT="$TIMETRAVEL10_WALLET_FORMAT"
    HCD=${NVOC}/miners/"$TIMETRAVEL10_MINER"/ccminer
    UCCALGO="-a timetravel10"
  ## PHI1612
  elif [[ $ALGO == PHI ]]
  then
    WALLET_ADDRESS_FORMAT="$PHI_WALLET_FORMAT"
    HCD=${NVOC}/miners/PHI_MINER/ccminer
    UCCALGO="-a phi"
  ## PASCAL
  elif [[ $ALGO == PASCAL ]]
  then
    WALLET_ADDRESS_FORMAT="$PASCAL_WALLET_FORMAT"
    HCD=${NVOC}/miners/pasc/sgminer
    UCCALGO="-k pascal"
  ## LBRY
  elif [[ $ALGO == LBRY ]]
  then
    WALLET_ADDRESS_FORMAT="$LBRY_WALLET_FORMAT"
    HCD=${NVOC}/miners/$LBRY_MINER/ccminer
    UCCALGO="-a lbry"
  ## DMD-GR
  elif [[ $ALGO == DMDGR ]]
  then
    WALLET_ADDRESS_FORMAT="$DMDGR_WALLET_FORMAT"
    HCD=${NVOC}/miners/$DMDGR_MINER/ccminer
    UCCALGO="-a dmd-gr"
  ## GROESTL
  elif [[ $ALGO == GROESTL ]]
  then
    WALLET_ADDRESS_FORMAT="$GROESTL_WALLET_FORMAT"
    HCD=${NVOC}/miners/$GROESTL_MINER/ccminer
    UCCALGO="-a groestl"
  ## MYRIAD GROESTL
  elif [[ $ALGO == MYR_GR ]]
  then
    WALLET_ADDRESS_FORMAT="$MYR_GR_WALLET_FORMAT"
    HCD=${NVOC}/miners/$MYR_GR_MINER/ccminer
    UCCALGO="-a myr-gr"
  ## DECRED
  elif [[ $ALGO == DCR ]]
  then
    WALLET_ADDRESS_FORMAT="$DCR_WALLET_FORMAT"
    HCD=${NVOC}/miners/$DCR_MINER/ccminer
    UCCALGO="-a decred"
  ## SIA
  elif [[ $ALGO == SIA ]]
  then
    WALLET_ADDRESS_FORMAT="$SIA_WALLET_FORMAT"
    HCD=${NVOC}/miners/$SIA_MINER/ccminer
    UCCALGO="-a sia"
  ## X13
  elif [[ $ALGO == X13 ]]
  then
    WALLET_ADDRESS_FORMAT="$X13_WALLET_FORMAT"
    HCD=${NVOC}/miners/$X13_MINER/ccminer
    UCCALGO="-a x13"
  elif [[ $ALGO == XEVAN ]]
  then
    WALLET_ADDRESS_FORMAT="$XEVAN_WALLET_FORMAT"
    UCCALGO="-a xevan"
    if [[ $XEVAN_MINER == Z-ENEMY ]]
    then
      HCD=${NVOC}/miners/z-enemy/z-enemy_miner
    else
      HCD=${NVOC}/miners/$XEVAN_MINER/ccminer
    fi
  elif [[ $ALGO == CRYPTONIGHT ]]
  then
    WALLET_ADDRESS_FORMAT="$CRYPTONIGHT_WALLET_FORMAT"
    HCD=${NVOC}/miners/KTccminer-cryptonight/ccminer
    UCCALGO=""
  elif [[ $ALGO == X16R ]];
  then
    UCCALGO="-a x16r"
    WALLET_ADDRESS_FORMAT=$X16R_WALLET_FORMAT
    if [[ $X16R_MINER == Z-ENEMY ]]
    then
      HCD=${NVOC}/miners/z-enemy/z-enemy_miner
    elif [[ $X16R_MINER == SILENT ]]
    then
      HCD=${NVOC}/miners/silent_miner/ccminer
    elif [[ $X16R_MINER == SUPRMINER ]]
    then
      HCD=${NVOC}/miners/suprminer/ccminer
    fi
  fi
  screen -c "${NVOC}"/screenrc-miner -dmSL miner "$HCD" "$UCCALGO" -o stratum+tcp://"${!xpool}":"${!xport}" -u "${!xadd}""$WALLET_ADDRESS_FORMAT""${!xwrk}" -p "$MINER_PWD" -i "${!xintensity}" "$CCMINER_OPTS"

## CRYPTONIGHTV7
elif [[ $ALGO == CRYPTONIGHTV7 ]];
then
# Remove nvidia.txt if cards count changed
  if [ -f ~/nvidia.txt ]
  then
    if [ "$(grep -c "// gpu:" ~/nvidia.txt)" != "$(nvidia-smi -i 0 --query-gpu=count --format=csv,noheader,nounits)" ]
    then
      rm ~/nvidia.txt
    fi
  fi
  # Change verbosity to show hashrate in output log
  if grep '"verbose_level" : 3' ~/config.txt
  then
    sed -i 's/"verbose_level" : 3/"verbose_level" : 4/g' ~/config.txt
  fi
  WALLET_ADDRESS_FORMAT="$CRYPTONIGHTV7_WALLET_FORMAT"
  HCD=${NVOC}/miners/xmr-stak/build/bin/xmr-stak_miner
  screen -c "${NVOC}"/screenrc-miner -dmSL miner "$HCD" --currency monero7 --noCPU --noAMD -o "${!xpool}":"${!xport}" -u "${!xadd}""$WALLET_ADDRESS_FORMAT""${!xwrk}" -p "$MINER_PWD" -i "${!xintensity}" "$CCMINER_OPTS"

else
  echo ""
  echo "COIN/ALGO not found, Check your settings"
  echo ""
fi
