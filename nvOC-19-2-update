#!/bin/bash
echo " nvOC by fullzero, unofficial 19.2 by papampi"
echo " Edits by papampi : Making tmpfs partition for log files to reduce SSD/USB/HDD read /writes, added option to auto start miner or not in 1bash, new 1bash for unified and separated pool and ports for wdog checking if pool is online, new separated 0miner to make 3main lighter and easier start miner, fix hostname conflict, add Warning to wdog and temp logs to ,  and many more edits and bug fixes"
echo " Edits by Stubo: simplified 3main, some wdog fixes, add dstm zm 5_5 version, and many more edits and bug fixes."
echo " Edits by leenoox: New and improved TEMP CONTROL, and many more fixes and suggestions."
echo " Backup your old 1bash and any important stuff"


if [[ -z $(head /home/m1/1bash | grep v0019.2) ]]; then
  echo "First things first, your 1bash is old, lets put the new 1bash to Downloads folder"
  while [[ -e /home/m1/Downloads/1bash  ]]
  do
    echo "There is a 1bash in Downloads folder, move it to some where else"
    echo "Waiting 30 seconds to move it"
    sleep 30
  done
  cd /home/m1/Downloads
  echo "wget https://www.dropbox.com/s/p5dvgyaoy73s8sc/1bash"
  wget https://www.dropbox.com/s/p5dvgyaoy73s8sc/1bash
  echo "New 1bash is added to /home/m1/Downloads"
  echo "You can now stop update to edit and make your new 1bash ready"
else
echo "Your 1bash is v0019.2, No edits needed"
fi

sleep 1;echo "";echo ""

echo "wait 30 seconds, if you have not edited your new 1bash or not backed up yet HIT ctrl+c NOW"
sleep 1;echo "";echo ""
echo "DO NOT OPEN THE TERMINAL OR RESTART THE RIG UNTIL UPDATE IS FININSHD AND EDITED YOUR NEW 1BASH"
echo "";echo ""
sleep 30;echo "";echo ""

echo " Stopping gnome-terminal, miner, wdog, temp, ..."
echo "pkill -f gnome-terminal"
pkill -f gnome-terminal
echo "pkill -f WATCHDOG"
pkill -f WATCHDOG
echo "pkill -f GRAM"
pkill -f GRAM
echo "pkill -f TEMP"
pkill -f TEMP
echo "pkill -f PAPAMPI"
pkill -f PAPAMPI
echo "pkill -e screen"
pkill -e screen

sleep 1;echo "";echo ""

echo "Checking hostname conflict"
if [[ -z $(cat /etc/hosts | grep $(cat /etc/hostname) ) ]]
then
  echo "hostname has conflict, temporarily fixing it"
  echo "sudo hostname m1-desktop"
  sudo hostname m1-desktop
else
  echo "No Problems found"
fi

sleep 1;echo "";echo ""

echo "Updating and Upgrading system packages and installing needed packages"
sudo -- sh -c 'apt-get update; apt-get upgrade -y; apt-get dist-upgrade -y; apt-get autoremove -y; apt-get autoclean -y; sudo apt-get install -y moreutils gawk -y'


sleep 1;echo "";echo ""

if [[ -z  $(cat /etc/screenrc | grep nvoc_log) ]]
then
  echo "Moving miner screenlog.o to tmpf to lower disk read/writes"
  echo "sudo echo "logfile  /home/m1/nvoc_logs/screenlog.0" | sudo tee -a  /etc/screenrc"
  sudo echo "logfile  /home/m1/nvoc_logs/screenlog.0" | sudo tee -a  /etc/screenrc
  sleep 1;echo "";echo ""
else
  echo "screen settings for screenlog.0 is ok"
fi

sleep 1;echo "";echo ""

if [[ -z  $(cat /etc/fstab | grep nvoc_log) ]]
then
  echo "making tmpfs nvoc_logs folder for logs"
  sleep 1;echo "";echo ""
  echo "mkdir -p /home/m1/nvoc_logs"
  mkdir -p /home/m1/nvoc_logs
  echo "sudo echo "tmpfs /home/m1/nvoc_logs tmpfs defaults,noatime,nosuid,nodev,noexec,mode=1777,size=512M 0 0" | sudo tee -a   /etc/fstab"
  sudo echo "tmpfs /home/m1/nvoc_logs tmpfs defaults,noatime,nosuid,nodev,noexec,mode=1777,size=512M 0 0" | sudo tee -a   /etc/fstab
  echo "sudo mount -a"
  sudo mount -a
else
  echo "tmpfs nvoc_logs already created"
fi

sleep 1;echo "";echo ""

echo "Downloading and making changes for DSTM ZM miner 0.5.6"
sleep 1;echo "";echo ""
echo "Downloading dstm zm miner 5_6"
echo "cd /home/m1/Downloads"
cd /home/m1/Downloads
wget https://www.dropbox.com/s/mfk12y75n45q7ff/DSTM_0.5.6.tar.gz
echo "Extracting the zm miner"
tar -xvzf DSTM_0.5.6.tar.gz
echo "rm /home/m1/Downloads/DSTM_0.5.6.tar.gz"
rm /home/m1/Downloads/DSTM_0.5.6.tar.gz
echo "mkdir -p /home/m1/zec/zm/5_6"
mkdir -p /home/m1/zec/zm/5_6
echo "mv /home/m1/Downloads/5_6 /home/m1/zec/zm"
mv /home/m1/Downloads/5_6 /home/m1/zec/zm/
echo "chmod a+x /home/m1/zec/zm/5_6/zm"
chmod a+x /home/m1/zec/zm/5_6/zm_miner
echo "mkdir -p /home/m1/zec/zm/latest"
mkdir -p /home/m1/zec/zm/latest
echo "cp /home/m1/zec/zm/5_6/zm_miner /home/m1/zec/zm/latest/zm_miner"
cp /home/m1/zec/zm/5_6/zm_miner /home/m1/zec/zm/latest/zm_miner
echo "chmod a+x /home/m1/zec/zm/latest/zm_miner"
chmod a+x /home/m1/zec/zm/latest/zm_miner

sleep 1;echo "";echo ""

echo "Downloading and making changes for Claymore 10_2"
echo "mkdir -p /home/m1/eth/claymore/"
mkdir -p /home/m1/eth/claymore/
echo "mkdir -p /home/m1/eth/claymore/10_2"
mkdir -p /home/m1/eth/claymore/10_2
echo "mkdir -p /home/m1/eth/claymore/latest"
mkdir -p /home/m1/eth/claymore/latest
echo "cd /home/m1/eth/"
cd /home/m1/eth/
echo "cp -r 8_0 9_4 9_5 9_7 9_8 10_0 /home/m1/eth/claymore/"
cp -r 8_0 9_4 9_5 9_7 9_8 10_0 /home/m1/eth/claymore/
echo "rm -rf 8_0 9_4 9_5 9_7 9_8 10_0 "
rm -rf 8_0 9_4 9_5 9_7 9_8 10_0
echo "cd /home/m1/Downloads"
cd /home/m1/Downloads
echo "wget https://www.dropbox.com/s/8ia1pv11h2a9628/Claymore-v10.2.tar.gz"
wget https://www.dropbox.com/s/8ia1pv11h2a9628/Claymore-v10.2.tar.gz
echo "tar -xvzf Claymore-v10.2.tar.gz"
tar -xvzf Claymore-v10.2.tar.gz
echo "rm /home/m1/Downloads/Claymore-v10.2.tar.gz"
rm /home/m1/Downloads/Claymore-v10.2.tar.gz
echo "mv Claymore-v10.2/* /home/m1/eth/claymore/10_2/"
mv Claymore-v10.2/* /home/m1/eth/claymore/10_2/
echo "rm -rf Claymore-v10.2"
rm -rf Claymore-v10.2
echo "cp /home/m1/eth/claymore/10_2/* /home/m1/eth/claymore/latest/"
cp /home/m1/eth/claymore/10_2/* /home/m1/eth/claymore/latest/
echo "chmod a+x /home/m1/eth/claymore/*/ethdcrminer64"
chmod a+x  /home/m1/eth/claymore/latest/ethdcrminer64

sleep 1;echo "";echo ""

echo "Downloading V19.2 unofficial updates"
wget https://www.dropbox.com/s/bajt2gaf87kgjrp/nvOC-19-2.tar.gz
echo "Extracting the update files"
tar -xvzf nvOC-19-2.tar.gz
echo "rm /home/m1/Downloads/nvOC-19-2.tar.gz"
rm /home/m1/Downloads/nvOC-19-2.tar.gz
echo "Making sure update files are in correct format"
dos2unix /home/m1/Downloads/nvOC-19-2/*

sleep 1;echo "";echo ""

echo " Checking hostname and permanently fixing it if there is conflict"
if [[ -z $(cat /etc/hosts | grep $(cat /etc/hostname) ) ]]
then
  echo "hostanema has conflict, Permanently fixing it"
  echo "sudo cp /home/m1/Downloads/nvOC-19-2/hosts /etc/hosts"
  sudo cp /home/m1/Downloads/nvOC-19-2/hosts /etc/hosts
  echo "sudo cp /home/m1/Downloads/nvOC-19-2/hostname /etc/hostname"
  sudo cp /home/m1/Downloads/nvOC-19-2/hostname /etc/hostname
else
  echo "hostname had no conflicts"
fi

sleep 1;echo "";echo ""

echo "Making a backup of changed files in /home/m1/backups"
echo "mkdir -p /home/m1/backups"
mkdir -p /home/m1/backups

sleep 1;echo "";echo ""

echo "cp /home/m1/1bash /home/m1/backups/1bash.bak"
cp /home/m1/1bash /home/m1/backups/1bash.bak
echo "cp /home/m1/3main /home/m1/backups/3main.bak"
cp /home/m1/3main /home/m1/backups/3main.bak
echo "mv /home/m1/Maxximus007_AUTO_TEMPERATURE_CONTROL /home/m1/backups/Maxximus007_AUTO_TEMPERATURE_CONTROL.bak"
mv /home/m1/Maxximus007_AUTO_TEMPERATURE_CONTROL /home/m1/backups/Maxximus007_AUTO_TEMPERATURE_CONTROL.bak
echo "mv /home/m1/IAmNotAJeep_and_Maxximus007_WATCHDOG /home/m1/backups/IAmNotAJeep_and_Maxximus007_WATCHDOG.bak"
mv /home/m1/IAmNotAJeep_and_Maxximus007_WATCHDOG /home/m1/backups/IAmNotAJeep_and_Maxximus007_WATCHDOG.bak
echo "mv /home/m1/PAPAMPI_WTM /home/m1/backups/PAPAMPI_WTM.bak"
mv /home/m1/PAPAMPI_WTM /home/m1/backups/PAPAMPI_WTM.bak
echo "mv /home/m1/PAPAMPI_PROFIT_CHECK /home/m1/backups/PAPAMPI_PROFIT_CHECK.bak"
mv /home/m1/PAPAMPI_PROFIT_CHECK /home/m1/backups/PAPAMPI_PROFIT_CHECK.bak

sleep 1;echo "";echo ""

echo "Copying updates"
sleep 1
echo " "
echo " "

if [[ -z $(head /home/m1/1bash | grep v0019.2) ]]; then
  echo "cp /home/m1/Downloads/nvOC-19-2/1bash /home/m1/1bash"
  cp /home/m1/Downloads/nvOC-19-2/1bash /home/m1/1bash
fi

echo "cp /home/m1/Downloads/nvOC-19-2/0miner /home/m1/0miner"
cp /home/m1/Downloads/nvOC-19-2/0miner /home/m1/0miner
echo "cp /home/m1/Downloads/nvOC-19-2/3main /home/m1/3main"
cp /home/m1/Downloads/nvOC-19-2/3main /home/m1/3main
echo "cp /home/m1/Downloads/nvOC-19-2/log_rotate /home/m1/log_rotate"
cp /home/m1/Downloads/nvOC-19-2/log_rotate /home/m1/log_rotate
echo "cp /home/m1/Downloads/nvOC-19-2/ext/minerinfo /home/m1/ext/cgi-bin/minerinfo"
cp /home/m1/Downloads/nvOC-19-2/ext/minerinfo /home/m1/ext/cgi-bin/minerinfo
echo "cp /home/m1/Downloads/nvOC-19-2/telegram /home/m1/telegram"
cp /home/m1/Downloads/nvOC-19-2/telegram /home/m1/telegram
echo "cp /home/m1/Downloads/nvOC-19-2/6tempcontrol /home/m1/6tempcontrol"
cp /home/m1/Downloads/nvOC-19-2/6tempcontrol /home/m1/6tempcontrol
echo "cp /home/m1/Downloads/nvOC-19-2/5watchdog /home/m1/5watchdog"
cp /home/m1/Downloads/nvOC-19-2/5watchdog /home/m1/5watchdog
echo "cp /home/m1/Downloads/nvOC-19-2/8wtm_auto_switch /home/m1/8wtm_auto_switch"
cp /home/m1/Downloads/nvOC-19-2/8wtm_auto_switch /home/m1/8wtm_auto_switch
echo "cp /home/m1/Downloads/nvOC-19-2/8wtm_profit_check /home/m1/8wtm_profit_check"
cp /home/m1/Downloads/nvOC-19-2/8wtm_profit_check /home/m1/8wtm_profit_check
echo "cp /home/m1/Downloads/nvOC-19-2/ext/WTM_SWITCHER /home/m1/WTM_SWITCHER"
cp /home/m1/Downloads/nvOC-19-2/ext/WTM_SWITCHER /home/m1/WTM_SWITCHER


sleep 1;echo "";echo ""

echo "chmod a+x /home/m1/www/cgi-bin/minerinfo"
chmod a+x /home/m1/www/cgi-bin/minerinfo
echo "chmod a+x /home/m1/www/cgi-bin/clearalerts"
chmod a+x /home/m1/www/cgi-bin/clearalerts
echo "touch /home/m1/nvoc_logs/5_restartlog"
touch /home/m1/nvoc_logs/5_restartlog
echo "touch /home/m1/nvoc_logs/6_autotemplog"
touch /home/m1/nvoc_logs/6_autotemplog
echo "touch /home/m1/WTM_switch_histrory"
touch /home/m1/WTM_switch_histrory
echo "touch /home/m1/nvoc_logs/screenlog.0"
touch /home/m1/nvoc_logs/screenlog.0
echo "touch /home/m1/7_wdog_alertlog"
touch /home/m1/7_wdog_alertlog
echo "touch /home/m1/7_temp_alertlog"
touch /home/m1/7_temp_alertlog
echo "chmod 666 /home/m1/nvoc_logs/*"
chmod 666 /home/m1/nvoc_logs/*
echo "chmod 666 /home/m1/7_*"
chmod 666 /home/m1/7_*

sleep 1;echo "";echo ""

touch /home/m1/.bash_aliases
if [[ -z  $(cat /home/m1/.bash_aliases | grep master-log) ]]
then
  echo "Adding master-log alias"
  echo "alias master-log='tail -f /home/m1/nvoc_logs/screenlog.0 /home/m1/nvoc_logs/5_restartlog /home/m1/nvoc_logs/6_autotemplog /home/m1/nvoc_logs/8_wtmautoswitchlog' " | tee -a /home/m1/.bash_aliases
  echo "type master-log in guake or ssh sessions, to watch all your logs live"
  echo " "
fi

if [[ -z  $(cat /home/m1/.bash_aliases | grep miner-restart) ]]
then
  echo "Adding miner-restart alias"
  echo "alias miner-restart='pkill -f WATCHDOG & pkill -f 3main'" | tee -a /home/m1/.bash_aliases
  echo "type miner-restart in guake or ssh sessions, to restart 3main"
  echo " "
fi

sleep 1;echo "";echo ""

echo "All Done"
echo "Old 1bash, 3main, wdog and temp are copied to /home/m1/backups/*.bak"
echo "Edit your 1bash then reboot your rig"
echo "Keep Calm and Carry on Mining"
